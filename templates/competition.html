{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ competition_name }}</h1>
    <a href="{{ submissions_page_url }}" target="_blank" class="btn btn-outline-dark">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right me-1" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
            <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
        </svg>
        View on Kaggle
    </a>
</div>

{% if submissions %}
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Notes</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Public Score</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody>
                {% for submission in submissions %}
                    {% set display_status = 'ERROR' if submission.status == 'COMPLETE' and not submission.public_score else submission.status %}
                    <tr>
                        <td>{{ submission.formatted_date }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-secondary edit-notes" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#notesModal"
                                    data-doc-id="{{ submission.doc_id }}"
                                    data-submission-desc="{{ submission.description }}"
                                    data-notes="{{ submission.notes if submission.notes else '' }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                                </svg>
                            </button>
                        </td>
                        <td>
                            <a href="{{ submission.url }}" target="_blank" class="text-decoration-none">{{ submission.description }}</a>
                            {% if submission.notes %}
                            <div class="small text-muted mt-1 notes-preview">{{ submission.notes|truncate(50, true) }}</div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {% if display_status == 'COMPLETE' %}bg-success{% elif display_status == 'PENDING' %}bg-warning{% elif display_status == 'ERROR' %}bg-danger{% else %}bg-secondary{% endif %}"
                                  {% if display_status == 'ERROR' %}data-bs-toggle="tooltip" title="Submission failed - No public score available"{% endif %}>
                                {{ display_status }}
                            </span>
                        </td>
                        <td>{{ submission.public_score if submission.public_score else '-' }}</td>
                        <td>{{ submission.formatted_duration }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notesModalLabel">Edit Notes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="notesForm">
                        <div class="mb-3">
                            <label for="submissionDescription" class="form-label fw-bold"></label>
                            <textarea class="form-control" id="notesText" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNotes">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            var tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

            const modal = document.getElementById('notesModal');
            const notesModal = new bootstrap.Modal(modal);

            document.querySelectorAll('.edit-notes').forEach(button => {
                button.addEventListener('click', function() {
                    const docId = this.getAttribute('data-doc-id');
                    const submissionDesc = this.getAttribute('data-submission-desc');
                    const notes = this.getAttribute('data-notes');
                    document.querySelector('#notesText').value = notes;
                    modal.setAttribute('data-doc-id', docId);
                });
            });

            document.getElementById('saveNotes').addEventListener('click', function() {
                const docId = modal.getAttribute('data-doc-id');
                const notes = document.querySelector('#notesText').value;
                
                fetch('/save_notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        competition_name: '{{ competition_name }}',
                        doc_id: docId,
                        notes: notes
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const button = document.querySelector(`.edit-notes[data-doc-id="${docId}"]`);
                        if (button) {
                            button.setAttribute('data-notes', notes);
                            // Refresh the page to show the updated notes
                            location.reload();
                        }
                        notesModal.hide();
                    } else {
                        alert('Failed to save notes: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to save notes. Please try again.');
                });
            });
        });
    </script>
{% else %}
    <div class="alert alert-info">
        No submissions found for this competition.
    </div>
{% endif %}
{% endblock %} 